# SmartProxy 系统代理配置指南

## Ubuntu 24 专用（默认直连，仅配置的走代理）

访问 http://localhost:5000/ubuntu24 查看 Ubuntu 24 PAC 配置说明，仅对 SmartProxy 中配置为「代理」的域名走代理，其余直连。

---

## 一、代理地址

| 用途     | 地址                      |
|----------|---------------------------|
| HTTP/HTTPS | `http://127.0.0.1:8080`  |
| SOCKS5   | `socks5://127.0.0.1:1081` |

**注意：** 不要使用 `socks5://127.0.0.1:1080`（这是 SSH 隧道直连，不会被 SmartProxy 监控）。

---

## 二、各系统配置方法

### Linux（GNOME/KDE 系统设置）

1. 打开 **设置 → 网络 → 代理**
2. 选择「手动」配置
3. 填写：
   - HTTP 代理：`127.0.0.1`
   - 端口：`8080`
   - HTTPS 代理：同 HTTP
4. 保存并关闭

或使用环境变量（终端）：
```bash
export http_proxy=http://127.0.0.1:8080
export https_proxy=http://127.0.0.1:8080
```

### macOS

1. **系统设置 → 网络 → 高级 → 代理**
2. 勾选「网页代理(HTTP)」「安全网页代理(HTTPS)」
3. 均填写：服务器 `127.0.0.1`，端口 `8080`
4. 点击「好」保存

### Windows

1. **设置 → 网络和 Internet → 代理**
2. 在「手动设置代理」下打开
3. 代理服务器地址：`127.0.0.1`
4. 端口：`8080`
5. 保存

---

## 三、浏览器特别注意

### 1. 使用系统代理

确保浏览器使用的是「系统代理」，而非单独配置：

- **Chrome/Edge**：无独立代理设置时，默认使用系统代理
- **Firefox**：设置 → 网络设置 → 选择「使用系统代理设置」

### 2. 关闭「绕过代理」

很多浏览器有「不代理的地址」列表，**百度等国内站点常被放入绕过列表**，导致流量不经代理，无法被收集。

**Chrome/Edge（跟随系统）：**  
在 Windows 系统中，代理设置里如有「不对以下地址使用代理」，应**清空**或**移除** `*.baidu.com`、`*.qq.com` 等。

**Firefox：**
1. 设置 → 网络设置 → 设置
2. 在「不使用代理的地址」中**删除** `localhost, 127.0.0.1` 以外的所有条目（或至少移除百度相关域名）

### 3. 停用可能接管代理的扩展

- 广告拦截、VPN、代理类扩展可能让流量不经过系统代理
- 测试时建议关闭或使用无痕模式（并关闭扩展）

---

## 四、验证代理是否生效

### 方法 1：终端测试

```bash
# 使用 HTTP 代理访问百度
curl -x http://127.0.0.1:8080 -I https://www.baidu.com
```

成功后，在 SmartProxy 状态列表中应能看到 `www.baidu.com` 的访问次数增加。

### 方法 2：查看 SmartProxy 界面

- 打开 http://localhost:5000
- 看「总请求」数字是否增加
- 若一直为 0，说明流量未经过 SmartProxy

### 方法 3：查看日志

SmartProxy 启动终端会输出 `[INFO] 自动添加规则: xxx` 或类似日志，有访问时会打印。

---

## 五、Telegram 等不跟随系统代理的应用

### 方式 A：网页添加代理应用（推荐）

1. 打开 http://localhost:5000
2. 在「代理应用」卡片点击「Telegram」快捷按钮（自动检测路径），或手动输入可执行路径
3. 点击「添加」
4. 从应用菜单启动「Telegram (经代理)」
5. **其他应用（Cursor 等）默认直连**

需先安装：`sudo apt install proxychains4`

### 方式 B：应用内配置

**Telegram Desktop**：设置 → 高级 → 连接类型 → 使用自定义代理 → SOCKS5 `127.0.0.1:1080`（直连 SSH 隧道）

### 方式 C：命令行生成启动脚本（备选）

若未使用网页「代理应用」，可手动生成：

```bash
cd smartproxy
./scripts/make-proxy-launcher.sh telegram "/path/to/Telegram"   # 自定义路径
# 或
./scripts/make-proxy-launcher.sh telegram   # 自动检测
```

会生成 `~/.local/bin/telegram-via-proxy`，从应用菜单启动「Telegram (经代理)」。**推荐使用方式 A（网页添加）**。

### 方式 D：透明代理（高级，影响所有应用）

所有应用自动走 SmartProxy，**包括 Cursor**，可能造成网络异常。仅当确实需要时使用。

详见 [docs/TRANSPARENT_PROXY.md](docs/TRANSPARENT_PROXY.md)

---

## 六、常见问题

| 现象 | 可能原因 | 解决办法 |
|------|----------|----------|
| Telegram 无法使用 | 未通过代理启动 | 在网页添加代理应用，从应用菜单启动「Telegram (经代理)」 |
| 总请求为 0 | 代理未指向 8080 | 检查系统/浏览器代理是否为 `127.0.0.1:8080` |
| 访问百度不更新 | 百度在绕过列表中 | 清空或修改浏览器的「不代理的地址」 |
| 访问国外站有记录 | 仅国内站无记录 | 可能是「国内直连」类扩展或规则 | 关闭相关扩展或规则 |
| 代理无法连接 | SmartProxy 未启动 | 先执行 `python app.py` 启动服务 |
| 网页添加代理应用后启动失败 | 未安装 proxychains4 | 执行 `sudo apt install proxychains4` |
