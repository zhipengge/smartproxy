<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartProxy - 智能流量分析</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f3f4f6; min-height: 100vh; margin: 0; padding: 24px; }
        .card { background: white; border-radius: 8px; padding: 24px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 24px; }
        .stat-value { font-size: 2rem; font-weight: bold; color: #2563eb; }
        .status-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; }
        .speed-ok { color: #16a34a; font-weight: 500; }
        .speed-fail { color: #dc2626; font-weight: 500; }
        .speed-none { color: #9ca3af; font-weight: 500; }
        .status-indicator { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; }
        .status-none { background: #9ca3af; }
        .status-fail { background: #dc2626; }
        .status-ok { background: #16a34a; }
    </style>
</head>
<body>
    <div style="max-width: 1400px; margin: 0 auto;">
        <!-- 标题 -->
        <div style="background: linear-gradient(135deg, #2563eb, #4f46e5); color: white; padding: 16px 24px; border-radius: 8px; margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center;">
            <h1 style="margin: 0; font-size: 1.5rem;">SmartProxy</h1>
            <div id="connection-status">
                <span class="status-dot" style="background: #ef4444;"></span>
                <span>连接中...</span>
            </div>
        </div>
        
        <!-- SSH 状态 -->
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <h2 style="margin: 0; font-size: 1.125rem;">SSH 隧道</h2>
                <div style="display: flex; gap: 8px;">
                    <button id="ssh-toggle" style="padding: 8px 16px; border-radius: 6px; cursor: pointer; background: #2563eb; color: white; border: none;">启动隧道</button>
                    <button id="refresh-status" style="padding: 8px 16px; border-radius: 6px; cursor: pointer; background: #6b7280; color: white; border: none;">刷新状态</button>
                </div>
            </div>
            <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 16px;">
                <div>
                    <div style="color: #6b7280; font-size: 0.875rem;">状态</div>
                    <div id="ssh-status" style="font-size: 1rem;">-</div>
                </div>
                <div>
                    <div style="color: #6b7280; font-size: 0.875rem;">本地端口</div>
                    <div id="ssh-port" style="font-size: 1rem;">-</div>
                </div>
                <div>
                    <div style="color: #6b7280; font-size: 0.875rem;">远程服务器</div>
                    <div id="ssh-host" style="font-size: 1rem;">-</div>
                </div>
                <div>
                    <div style="color: #6b7280; font-size: 0.875rem;">系统代理</div>
                    <div id="proxy-env" style="font-size: 1rem;">-</div>
                </div>
                <div>
                    <div style="color: #6b7280; font-size: 0.875rem;">HTTP 代理</div>
                    <div id="http-proxy-url" style="font-size: 1rem;">-</div>
                </div>
                <div>
                    <div style="color: #6b7280; font-size: 0.875rem;">PAC 地址</div>
                    <div id="pac-url" style="font-size: 0.875rem;">-</div>
                </div>
                <div>
                    <div style="color: #6b7280; font-size: 0.875rem;">SOCKS5 代理</div>
                    <div id="socks5-proxy-url" style="font-size: 1rem;">-</div>
                </div>
            </div>
        </div>
        
        <!-- 代理应用：网页可配置，其他应用默认直连 -->
        <div class="card">
            <h2 style="margin: 0 0 4px 0; font-size: 1.125rem;">代理应用</h2>
            <div style="color: #6b7280; font-size: 0.875rem; margin-bottom: 16px;">添加需走代理的应用（如 Telegram），从应用菜单启动「xxx (经代理)」，<strong>其他应用（Cursor 等）默认直连</strong></div>
            <div style="display: flex; gap: 8px; flex-wrap: wrap; align-items: center; margin-bottom: 16px;">
                <input type="text" id="proxy-app-name" placeholder="应用名 (如 telegram)" style="width: 120px; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;">
                <input type="text" id="proxy-app-exec" placeholder="可执行路径" style="flex: 1; min-width: 200px; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;">
                <button id="proxy-app-add" style="padding: 8px 16px; background: #2563eb; color: white; border: none; border-radius: 6px; cursor: pointer;">添加</button>
            </div>
            <div style="font-size: 0.8125rem; color: #6b7280; margin-bottom: 8px;">快捷添加：</div>
            <div id="proxy-app-presets" style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 16px;"></div>
            <div id="proxy-app-list" style="border: 1px solid #e5e7eb; border-radius: 6px; overflow: hidden;">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead><tr style="background: #f9fafb;"><th style="padding: 10px; text-align: left;">应用</th><th style="padding: 10px; text-align: left;">可执行路径</th><th style="padding: 10px; width: 80px;">操作</th></tr></thead>
                    <tbody id="proxy-app-tbody"></tbody>
                </table>
                <div id="proxy-app-empty" style="padding: 24px; text-align: center; color: #9ca3af;">暂无，添加后从应用菜单启动「xxx (经代理)」</div>
            </div>
        </div>
        
        <!-- 透明代理（高级，默认隐藏） -->
        <div class="card" id="transparent-proxy-card" style="display: none;">
            <details>
                <summary style="cursor: pointer; font-size: 1rem;">透明代理（高级）— 启用后所有应用经 VPS，可能影响 Cursor</summary>
                <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e7eb;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span id="transparent-status" style="font-size: 0.875rem;">-</span>
                        <div style="display: flex; gap: 8px;">
                            <button id="transparent-enable" style="padding: 8px 16px; border-radius: 6px; cursor: pointer; background: #2563eb; color: white; border: none;">启用</button>
                            <button id="transparent-disable" style="padding: 8px 16px; border-radius: 6px; cursor: pointer; background: #6b7280; color: white; border: none;">禁用</button>
                        </div>
                    </div>
                </div>
            </details>
        </div>
        
        <!-- 配置提示（当无流量时显示） -->
        <div id="config-hint" style="display: none; background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 12px 16px; margin-bottom: 24px; font-size: 0.875rem;">
            <strong>⚙️ 自动收集未生效？</strong> 请将系统/浏览器代理设为 <code style="background:#fff;padding:2px 6px;border-radius:4px;">http://127.0.0.1:8080</code>，
            并确保 <strong>百度等国内站点未被加入「不代理的地址」</strong>。详见 <a href="/configure" target="_blank" style="color:#2563eb;">配置指南</a>
        </div>
        
        <!-- 统计 -->
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px;">
            <div class="card" style="text-align: center;">
                <div class="stat-value" id="stat-total">0</div>
                <div style="color: #6b7280; font-size: 0.875rem;">总请求</div>
            </div>
            <div class="card" style="text-align: center;">
                <div class="stat-value" id="stat-direct" style="color: #16a34a;">0</div>
                <div style="color: #6b7280; font-size: 0.875rem;">直连</div>
            </div>
            <div class="card" style="text-align: center;">
                <div class="stat-value" id="stat-proxy" style="color: #dc2626;">0</div>
                <div style="color: #6b7280; font-size: 0.875rem;">代理</div>
            </div>
            <div class="card" style="text-align: center;">
                <div class="stat-value" id="stat-percent" style="color: #2563eb;">0%</div>
                <div style="color: #6b7280; font-size: 0.875rem;">代理比例</div>
            </div>
        </div>
        
        <!-- 添加规则 -->
        <div class="card">
            <h2 style="margin: 0 0 16px 0; font-size: 1.125rem;">添加规则</h2>
            <div style="display: flex; gap: 8px; flex-wrap: wrap; align-items: center;">
                <input type="text" id="rule-domain" placeholder="域名 (如: huggingface.co)" 
                       style="flex: 1; min-width: 180px; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;">
                <select id="rule-action" style="padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;">
                    <option value="proxy">代理</option>
                    <option value="direct">直连</option>
                </select>
                <input type="number" id="rule-priority" placeholder="优先级" value="0" 
                       style="width: 80px; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;" title="数字越大优先级越高">
                <button id="add-rule" style="padding: 8px 16px; background: #2563eb; color: white; border: none; border-radius: 6px; cursor: pointer;">添加</button>
            </div>
        </div>
        
        <!-- 编辑规则弹窗 -->
        <div id="edit-modal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 100; justify-content: center; align-items: center;">
            <div style="background: white; border-radius: 8px; padding: 24px; min-width: 360px; box-shadow: 0 4px 20px rgba(0,0,0,0.2);">
                <h3 style="margin: 0 0 16px 0; font-size: 1.125rem;">编辑规则</h3>
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <div>
                        <label style="display: block; margin-bottom: 4px; font-size: 0.875rem; color: #6b7280;">域名</label>
                        <input type="text" id="edit-domain" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 4px; font-size: 0.875rem; color: #6b7280;">类型</label>
                        <select id="edit-action" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;">
                            <option value="proxy">代理</option>
                            <option value="direct">直连</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 4px; font-size: 0.875rem; color: #6b7280;">优先级</label>
                        <input type="number" id="edit-priority" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;" placeholder="0">
                    </div>
                </div>
                <div style="display: flex; gap: 8px; justify-content: flex-end; margin-top: 20px;">
                    <button id="edit-cancel" style="padding: 8px 16px; background: #e5e7eb; color: #374151; border: none; border-radius: 6px; cursor: pointer;">取消</button>
                    <button id="edit-save" style="padding: 8px 16px; background: #2563eb; color: white; border: none; border-radius: 6px; cursor: pointer;">保存</button>
                </div>
            </div>
        </div>
        
        <!-- 状态列表 -->
        <div class="card" style="overflow-x: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <h2 style="margin: 0; font-size: 1.125rem;">状态列表 <span id="rules-count" style="color: #6b7280; font-size: 0.875rem;">(0)</span></h2>
                <div style="display: flex; gap: 8px;">
                    <button id="test-all" style="padding: 8px 16px; background: #059669; color: white; border: none; border-radius: 6px; cursor: pointer;">测试所有</button>
                    <button id="clear-status" style="padding: 8px 16px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer;">清除状态</button>
                </div>
            </div>
            <table style="width: 100%; min-width: 900px; border-collapse: collapse;">
                <thead>
                    <tr style="background: #f9fafb; text-align: left;">
                        <th style="padding: 12px;">状态</th>
                        <th style="padding: 12px;">域名</th>
                        <th style="padding: 12px;">类型</th>
                        <th style="padding: 12px;">访问次数</th>
                        <th style="padding: 12px;">最后访问</th>
                        <th style="padding: 12px;">下载 (M/s)</th>
                        <th style="padding: 12px;">上传 (M/s)</th>
                        <th style="padding: 12px;">优先级</th>
                        <th style="padding: 12px;">操作</th>
                    </tr>
                </thead>
                <tbody id="rules-list"></tbody>
            </table>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        const socket = io();
        
        socket.on('connect', function() {
            document.getElementById('connection-status').innerHTML = 
                '<span class="status-dot" style="background: #22c55e;"></span><span>已连接</span>';
            socket.emit('request_update');
            loadProxyApps();
            loadProxyAppPresets();
        });
        
        function loadProxyApps() {
            fetch('/api/proxy-apps').then(r => r.json()).then(apps => {
                const tbody = document.getElementById('proxy-app-tbody');
                const empty = document.getElementById('proxy-app-empty');
                if (apps.length === 0) {
                    tbody.innerHTML = '';
                    empty.style.display = 'block';
                    return;
                }
                empty.style.display = 'none';
                tbody.innerHTML = apps.map(a => {
                    const nameId = (a.name || '').replace(/\\/g, '\\\\').replace(/'/g, "\\'");
                    const displayName = (a.desktop_name || a.name || '').replace(/</g, '&lt;');
                    return '<tr style="border-top:1px solid #e5e7eb"><td style="padding:10px">' + displayName + '</td><td style="padding:10px;font-family:monospace;font-size:0.875rem">' + (a.exec || '').replace(/</g, '&lt;') + '</td><td style="padding:10px"><button onclick="removeProxyApp(\'' + nameId + '\')" style="padding:4px 8px;background:#dc2626;color:white;border:none;border-radius:4px;cursor:pointer">移除</button></td></tr>';
                }).join('');
            });
        }
        
        function loadProxyAppPresets() {
            fetch('/api/proxy-apps/presets').then(r => r.json()).then(presets => {
                document.getElementById('proxy-app-presets').innerHTML = presets.map(p => {
                    return '<button type="button" class="preset-btn" data-name="' + (p.name || p.id) + '" data-exec="' + (p.exec || '').replace(/"/g, '&quot;') + '" data-desktop="' + (p.desktop_name || p.name) + '" style="padding:6px 12px;background:#e5e7eb;color:#374151;border:none;border-radius:6px;cursor:pointer;font-size:0.875rem">' + (p.desktop_name || p.name) + '</button>';
                }).join('');
                document.querySelectorAll('.preset-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        document.getElementById('proxy-app-name').value = this.dataset.name || '';
                        document.getElementById('proxy-app-exec').value = this.dataset.exec || '';
                    });
                });
            });
        }
        
        function addProxyApp(name, exec, desktopName) {
            if (!name || !exec) return alert('请输入应用名和可执行路径');
            fetch('/api/proxy-apps', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ name: name.trim(), exec: exec.trim(), desktop_name: (desktopName || name).trim() })
            }).then(r => r.json()).then(data => {
                if (data.success) {
                    loadProxyApps();
                    document.getElementById('proxy-app-name').value = '';
                    document.getElementById('proxy-app-exec').value = '';
                    if (data.message) alert(data.message);
                } else {
                    alert(data.message || '添加失败');
                }
            }).catch(() => alert('请求失败'));
        }
        
        window.removeProxyApp = function(name) {
            if (!confirm('确定移除 ' + name + '？')) return;
            fetch('/api/proxy-apps/' + encodeURIComponent(name), { method: 'DELETE' })
                .then(r => r.json())
                .then(data => { if (data.success) loadProxyApps(); else alert(data.message); });
        };
        
        socket.on('disconnect', function() {
            document.getElementById('connection-status').innerHTML = 
                '<span class="status-dot" style="background: #ef4444;"></span><span>已断开</span>';
        });
        
        socket.on('status_update', updateStatus);
        socket.on('stats_update', updateStats);
        socket.on('rules_update', updateRules);
        
        function updateStatus(data) {
            const ssh = data.ssh_tunnel;
            const btn = document.getElementById('ssh-toggle');
            
            if (ssh.running) {
                btn.textContent = '停止隧道';
                btn.style.background = '#dc2626';
                document.getElementById('ssh-status').innerHTML = '<span style="color: #16a34a;">● 运行中</span>';
            } else {
                btn.textContent = '启动隧道';
                btn.style.background = '#2563eb';
                document.getElementById('ssh-status').innerHTML = '<span style="color: #6b7280;">● 已停止</span>';
            }
            
            document.getElementById('ssh-port').textContent = ssh.local_port || '-';
            document.getElementById('ssh-host').textContent = ssh.remote_host || '未配置';
            document.getElementById('proxy-env').textContent = data.proxy_env || '-';
            const hp = data.http_proxy;
            document.getElementById('http-proxy-url').textContent = (hp && hp.enabled && hp.url) ? hp.url : '-';
            const sp = data.socks5_proxy;
            document.getElementById('socks5-proxy-url').textContent = (sp && sp.enabled && sp.url) ? sp.url : '-';
            document.getElementById('pac-url').textContent = data.pac_url || '-';
            
            const tp = data.transparent_proxy;
            const tpCard = document.getElementById('transparent-proxy-card');
            const tpStatus = document.getElementById('transparent-status');
            const tpEnable = document.getElementById('transparent-enable');
            const tpDisable = document.getElementById('transparent-disable');
            if (tp && tp.linux) {
                tpCard.style.display = 'block';
                if (tp.active) {
                    tpStatus.innerHTML = '<span style="color:#16a34a;">● 已启用</span>';
                    tpEnable.style.display = 'none';
                    tpDisable.style.display = 'inline-block';
                } else if (tp.enabled) {
                    tpStatus.innerHTML = '<span style="color:#f59e0b;">● 配置已启用，等待执行</span>';
                    tpEnable.style.display = 'inline-block';
                    tpDisable.style.display = 'inline-block';
                } else {
                    tpStatus.innerHTML = '<span style="color:#6b7280;">● 已禁用</span>';
                    tpEnable.style.display = 'inline-block';
                    tpDisable.style.display = 'none';
                }
            } else {
                tpCard.style.display = 'none';
            }
        }
        
        function updateStats(data) {
            document.getElementById('stat-total').textContent = data.total_requests;
            document.getElementById('stat-direct').textContent = data.direct_requests;
            document.getElementById('stat-proxy').textContent = data.proxied_requests;
            document.getElementById('stat-percent').textContent = data.proxied_percent + '%';
            document.getElementById('config-hint').style.display = (data.total_requests === 0 && data.runtime_seconds > 10) ? 'block' : 'none';
        }
        
        function formatSpeed(value) {
            if (value === null || value === undefined || value === 0) {
                return '<span class="speed-none">0</span>';
            } else if (value === -1) {
                return '<span class="speed-fail">-1</span>';
            } else {
                return '<span class="speed-ok">' + value.toFixed(2) + '</span>';
            }
        }
        
        function formatStatus(status) {
            if (status === null || status === undefined || status === 0) {
                return '<span class="status-indicator status-none"></span><span class="speed-none">无访问</span>';
            } else if (status === -1) {
                return '<span class="status-indicator status-fail"></span><span class="speed-fail">失败</span>';
            } else {
                return '<span class="status-indicator status-ok"></span><span class="speed-ok">正常</span>';
            }
        }
        
        let rulesCache = [];
        function updateRules(rules) {
            rulesCache = rules;
            document.getElementById('rules-count').textContent = '(' + rules.length + ')';
            document.getElementById('rules-list').innerHTML = rules.map(rule => {
                const down = rule.down_speed !== undefined ? rule.down_speed : null;
                const up = rule.up_speed !== undefined ? rule.up_speed : null;
                const status = rule.status !== undefined ? rule.status : null;
                const accessCount = rule.access_count || 0;
                const lastAccess = rule.last_access ? (rule.last_access.replace('T', ' ').substring(0, 19)) : '-';
                const domainEsc = (rule.domain || '').replace(/\\/g, '\\\\').replace(/'/g, "\\'");
                return '<tr style="border-bottom: 1px solid #e5e7eb;">' +
                '<td style="padding: 12px;">' + formatStatus(status) + '</td>' +
                '<td style="padding: 12px; font-family: monospace;">' + rule.domain + '</td>' +
                '<td style="padding: 12px;"><span style="' + 
                    (rule.action === 'proxy' ? 'background: #fee2e2; color: #991b1b;' : 'background: #dcfce7; color: #166534;') + 
                    ' padding: 4px 8px; border-radius: 4px; font-size: 0.875rem;">' + 
                    (rule.action === 'proxy' ? '代理' : '直连') + '</span></td>' +
                '<td style="padding: 12px; color: #6b7280;">' + accessCount + '</td>' +
                '<td style="padding: 12px; color: #6b7280; font-size: 0.875rem;">' + lastAccess + '</td>' +
                '<td style="padding: 12px;">' + formatSpeed(down) + '</td>' +
                '<td style="padding: 12px;">' + formatSpeed(up) + '</td>' +
                '<td style="padding: 12px; color: #6b7280;">' + rule.priority + '</td>' +
                '<td style="padding: 12px;">' +
                    '<button onclick="editRule(\'' + domainEsc + '\')" style="padding: 4px 8px; background: #2563eb; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 4px;">编辑</button>' +
                    '<button onclick="testRule(\'' + domainEsc + '\', this)" style="padding: 4px 8px; background: #059669; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 4px;">测试</button>' +
                    '<button onclick="deleteRule(\'' + domainEsc + 
                    '\')" style="padding: 4px 8px; background: #dc2626; color: white; border: none; border-radius: 4px; cursor: pointer;">删除</button></td>' +
                '</tr>';
            }).join('');
        }
        
        document.getElementById('proxy-app-add').addEventListener('click', function() {
            const name = document.getElementById('proxy-app-name').value.trim();
            const exec = document.getElementById('proxy-app-exec').value.trim();
            addProxyApp(name, exec, name);
        });
        
        document.getElementById('add-rule').addEventListener('click', function() {
            const domain = document.getElementById('rule-domain').value.trim();
            const action = document.getElementById('rule-action').value;
            const priority = parseInt(document.getElementById('rule-priority').value) || 0;
            if (!domain) return alert('请输入域名');
            
            fetch('/api/rules', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ domain, action, priority })
            }).then(r => r.json()).then(data => {
                if (data && data.success) {
                    document.getElementById('rule-domain').value = '';
                    socket.emit('request_update');
                } else {
                    alert(data && data.message ? data.message : '添加失败');
                }
            }).catch(() => alert('请求失败，请检查网络'));
        });
        
        document.getElementById('test-all').addEventListener('click', function() {
            const btn = this;
            btn.disabled = true;
            btn.textContent = '测试中...';
            fetch('/api/rules/test-all', { method: 'POST' })
                .then(r => r.json())
                .then(() => { socket.emit('request_update'); })
                .finally(() => {
                    btn.disabled = false;
                    btn.textContent = '测试所有';
                });
        });
        
        document.getElementById('clear-status').addEventListener('click', function() {
            fetch('/api/rules/clear-status', { method: 'POST' })
                .then(r => r.json())
                .then(() => socket.emit('request_update'));
        });
        
        document.getElementById('refresh-status').addEventListener('click', function() {
            socket.emit('request_update');
        });
        
        document.getElementById('ssh-toggle').addEventListener('click', function() {
            const btn = this;
            const isRunning = btn.textContent === '停止隧道';
            btn.disabled = true;
            fetch(isRunning ? '/api/ssh/stop' : '/api/ssh/start', { method: 'POST' })
                .then(r => r.json())
                .then(data => {
                    socket.emit('request_update');
                    if (!isRunning && data && !data.success) {
                        alert('启动失败: ' + (data.message || '请检查 config.yaml 中的 remote_host'));
                    }
                })
                .finally(() => { btn.disabled = false; });
        });
        
        document.getElementById('transparent-enable').addEventListener('click', function() {
            const btn = this;
            btn.disabled = true;
            fetch('/api/transparent-proxy/enable', { method: 'POST' })
                .then(r => r.json())
                .then(data => {
                    socket.emit('request_update');
                    if (data && !data.success) {
                        alert('启用失败: ' + (data.message || '未知错误') + '\n可尝试: sudo scripts/setup-transparent-proxy.sh enable');
                    }
                })
                .catch(() => alert('请求失败'))
                .finally(() => { btn.disabled = false; });
        });
        
        document.getElementById('transparent-disable').addEventListener('click', function() {
            const btn = this;
            btn.disabled = true;
            fetch('/api/transparent-proxy/disable', { method: 'POST' })
                .then(r => r.json())
                .then(data => {
                    socket.emit('request_update');
                    if (data && !data.success) {
                        alert('禁用失败: ' + (data.message || '未知错误'));
                    }
                })
                .catch(() => alert('请求失败'))
                .finally(() => { btn.disabled = false; });
        });
        
        window.deleteRule = function(domain) {
            if (confirm('确定删除规则: ' + domain + '？')) {
                fetch('/api/rules/' + encodeURIComponent(domain), { method: 'DELETE' })
                    .then(r => r.json())
                    .then(data => {
                        socket.emit('request_update');
                        if (data && !data.success) alert(data.message || '删除失败');
                    })
                    .catch(() => alert('请求失败'));
            }
        };
        
        window.testRule = function(domain, btn) {
            if (btn) { btn.disabled = true; btn.textContent = '...'; }
            fetch('/api/rules/' + encodeURIComponent(domain) + '/test', { method: 'POST' })
                .then(r => r.json())
                .then(() => socket.emit('request_update'))
                .finally(() => {
                    if (btn) { btn.disabled = false; btn.textContent = '测试'; }
                });
        };
        
        window.editRule = function(domain) {
            const rule = rulesCache.find(r => r.domain === domain);
            if (!rule) return;
            document.getElementById('edit-domain').value = rule.domain;
            document.getElementById('edit-action').value = rule.action;
            document.getElementById('edit-priority').value = rule.priority || 0;
            document.getElementById('edit-modal').dataset.originalDomain = domain;
            document.getElementById('edit-modal').style.display = 'flex';
        };
        
        document.getElementById('edit-cancel').addEventListener('click', function() {
            document.getElementById('edit-modal').style.display = 'none';
        });
        
        document.getElementById('edit-save').addEventListener('click', function() {
            const originalDomain = document.getElementById('edit-modal').dataset.originalDomain;
            const domain = document.getElementById('edit-domain').value.trim();
            const action = document.getElementById('edit-action').value;
            const priority = parseInt(document.getElementById('edit-priority').value) || 0;
            if (!domain) return alert('请输入域名');
            
            const doSave = () => {
                fetch('/api/rules', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ domain, action, priority })
                }).then(r => r.json()).then(data => {
                    if (data && data.success) {
                        document.getElementById('edit-modal').style.display = 'none';
                        socket.emit('request_update');
                    } else {
                        alert(data && data.message ? data.message : '保存失败');
                    }
                }).catch(() => alert('请求失败'));
            };
            
            if (domain !== originalDomain) {
                fetch('/api/rules/' + encodeURIComponent(originalDomain), { method: 'DELETE' })
                    .then(r => r.json())
                    .then(data => {
                        if (data && !data.success) return alert(data.message || '删除旧规则失败');
                        doSave();
                    })
                    .catch(() => alert('请求失败'));
            } else {
                doSave();
            }
        });
    </script>
</body>
</html>
